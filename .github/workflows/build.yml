name: build
permissions:
  contents: write

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  pytest:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.9", "3.10", "3.11", "3.12" ]

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install flake8
          pip install '.[test]'
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=140 --statistics
      - name: Test with pytest and coverage
        run: |
          pytest --cov=bsv --cov-report=html --cov-report=term --cov-report=xml
      - name: Extract coverage percentage
        if: matrix.python-version == '3.11'
        id: coverage
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; root = ET.parse('coverage.xml').getroot(); print(f\"{float(root.attrib['line-rate'])*100:.1f}\")")
          echo "coverage_percentage=$COVERAGE" >> $GITHUB_OUTPUT
      - name: Update README with coverage
        if: matrix.python-version == '3.11' && github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          python update_coverage.py ${{ steps.coverage.outputs.coverage_percentage }}
      - name: Commit coverage update
        if: matrix.python-version == '3.11' && github.ref == 'refs/heads/master' && github.event_name == 'push'
        # Pin to specific commit SHA for security - v9.1.4
        uses: EndBug/add-and-commit@777a761e0f8293b7b051170404976d7cf10611cb  # v9.1.4
        with:
          add: README.md
          message: "Update coverage badge to ${{ steps.coverage.outputs.coverage_percentage }}%"
          author_name: github-actions[bot]
          author_email: github-actions[bot]@users.noreply.github.com
